name: Test Init

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Build bld CLI
        run: go build -o /tmp/bld-cli ./cmd/bld

      - name: Create test project
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          go mod init example.com/test-project

      - name: Run bld init
        run: |
          cd /tmp/test-project
          /tmp/bld-cli init

      - name: Verify files created
        run: |
          cd /tmp/test-project
          test -f .bld/go.mod
          test -f .bld/config.go
          test -f .bld/main.go
          test -f .bld/.gitignore
          test -f bld

      - name: Verify go.mod content
        run: |
          cd /tmp/test-project
          grep "module example.com/test-project-build" .bld/go.mod
          grep "github.com/fredrikaverpil/bld" .bld/go.mod

      - name: List available tasks
        run: |
          cd /tmp/test-project
          ./bld -h

      - name: Run go-fmt task
        run: |
          cd /tmp/test-project
          ./bld go-fmt

      - name: Run go-test task
        run: |
          cd /tmp/test-project
          ./bld go-test
