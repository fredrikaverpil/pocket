#!/bin/bash
set -e

POK_DIR="{{.PocketDir}}"
POK_CONTEXT="{{.Context}}"
GO_VERSION="{{.GoVersion}}"
GO_INSTALL_DIR="$POK_DIR/tools/go/$GO_VERSION"
GO_BIN="$GO_INSTALL_DIR/go/bin/go"

# Find Go binary
if command -v go &> /dev/null; then
    GO_CMD="go"
elif [[ -x "$GO_BIN" ]]; then
    GO_CMD="$GO_BIN"
else
    # Download Go
    echo "Go not found, downloading go$GO_VERSION..."
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)
    [[ "$ARCH" == "x86_64" ]] && ARCH="amd64"
    [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]] && ARCH="arm64"

    # Get expected checksum for this platform
    EXPECTED_SHA256=""
    case "${OS}-${ARCH}" in
{{- range $key, $value := .GoChecksums }}
        "{{ $key }}") EXPECTED_SHA256="{{ $value }}" ;;
{{- end }}
    esac

    DOWNLOAD_URL="https://go.dev/dl/go${GO_VERSION}.${OS}-${ARCH}.tar.gz"
    DOWNLOAD_FILE=$(mktemp)
    trap 'rm -f "$DOWNLOAD_FILE"' EXIT

    curl -fsSL "$DOWNLOAD_URL" -o "$DOWNLOAD_FILE"

    # Verify checksum if we have an expected value and a tool to compute it
    if [[ -n "$EXPECTED_SHA256" ]]; then
        ACTUAL_SHA256=""
        if command -v sha256sum &> /dev/null; then
            ACTUAL_SHA256=$(sha256sum "$DOWNLOAD_FILE" | cut -d' ' -f1)
        elif command -v shasum &> /dev/null; then
            ACTUAL_SHA256=$(shasum -a 256 "$DOWNLOAD_FILE" | cut -d' ' -f1)
        elif command -v openssl &> /dev/null; then
            ACTUAL_SHA256=$(openssl dgst -sha256 "$DOWNLOAD_FILE" | awk '{print $NF}')
        fi

        if [[ -n "$ACTUAL_SHA256" ]]; then
            if [[ "$ACTUAL_SHA256" != "$EXPECTED_SHA256" ]]; then
                echo "Checksum verification failed!" >&2
                echo "Expected: $EXPECTED_SHA256" >&2
                echo "Actual:   $ACTUAL_SHA256" >&2
                exit 1
            fi
            echo "Checksum verified."
        else
            echo "Warning: No checksum tool available (sha256sum, shasum, or openssl), skipping verification."
        fi
    else
        echo "Warning: No checksum available for ${OS}-${ARCH}, skipping verification."
    fi

    mkdir -p "$GO_INSTALL_DIR"
    tar -xzf "$DOWNLOAD_FILE" -C "$GO_INSTALL_DIR"
    GO_CMD="$GO_BIN"
    echo "Go $GO_VERSION installed to $GO_INSTALL_DIR"
fi

POK_CONTEXT="$POK_CONTEXT" "$GO_CMD" run -C "$POK_DIR" . "$@"
