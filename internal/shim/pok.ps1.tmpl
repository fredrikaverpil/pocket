$ErrorActionPreference = "Stop"

$PocketDir = "{{.PocketDir}}"
$PocketContext = "{{.Context}}"
$GoVersion = "{{.GoVersion}}"
$GoInstallDir = "$PocketDir\tools\go\$GoVersion"
$GoBin = "$GoInstallDir\go\bin\go.exe"

# Find Go binary.
$GoCmd = $null
if (Get-Command go -ErrorAction SilentlyContinue) {
    $GoCmd = "go"
} elseif (Test-Path $GoBin) {
    $GoCmd = $GoBin
} else {
    # Download Go.
    Write-Host "Go not found, downloading go$GoVersion..."

    $Arch = if ([Environment]::Is64BitOperatingSystem) { "amd64" } else { "386" }
    $ZipUrl = "https://go.dev/dl/go$GoVersion.windows-$Arch.zip"
    $ZipPath = "$env:TEMP\go$GoVersion.zip"

    New-Item -ItemType Directory -Force -Path $GoInstallDir | Out-Null
    Invoke-WebRequest -Uri $ZipUrl -OutFile $ZipPath
    Expand-Archive -Path $ZipPath -DestinationPath $GoInstallDir -Force
    Remove-Item $ZipPath

    $GoCmd = $GoBin
    Write-Host "Go $GoVersion installed to $GoInstallDir"
}

# Insert -v before -- if present, otherwise append it.
$NewArgs = @()
$FoundSeparator = $false
foreach ($arg in $args) {
    if ($arg -eq "--") {
        $NewArgs += "-v"
        $NewArgs += "--"
        $FoundSeparator = $true
    } else {
        $NewArgs += $arg
    }
}
if (-not $FoundSeparator) {
    $NewArgs += "-v"
}

$env:POK_CONTEXT = $PocketContext
& $GoCmd run -C $PocketDir . @NewArgs
exit $LASTEXITCODE
