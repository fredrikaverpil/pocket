#!/bin/bash
set -e

POK_DIR=".pocket"
POK_CONTEXT="."
GO_VERSION="1.25.5"
GO_INSTALL_DIR="$POK_DIR/tools/go/$GO_VERSION"
GO_BIN="$GO_INSTALL_DIR/go/bin/go"

# Find Go binary
if command -v go &> /dev/null; then
    GO_CMD="go"
elif [[ -x "$GO_BIN" ]]; then
    GO_CMD="$GO_BIN"
else
    # Download Go
    echo "Go not found, downloading go$GO_VERSION..."
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)
    [[ "$ARCH" == "x86_64" ]] && ARCH="amd64"
    [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]] && ARCH="arm64"

    mkdir -p "$GO_INSTALL_DIR"
    curl -fsSL "https://go.dev/dl/go${GO_VERSION}.${OS}-${ARCH}.tar.gz" | tar -xz -C "$GO_INSTALL_DIR"
    GO_CMD="$GO_BIN"
    echo "Go $GO_VERSION installed to $GO_INSTALL_DIR"
fi

# Insert -v before -- if present, otherwise append it
args=()
found_separator=false
for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
        args+=("-v" "--")
        found_separator=true
    else
        args+=("$arg")
    fi
done
if [[ "$found_separator" == "false" ]]; then
    args+=("-v")
fi

POK_CONTEXT="$POK_CONTEXT" "$GO_CMD" run -C "$POK_DIR" . "${args[@]}"
